#!/bin/sh
#
# Unit generator for unlocking and mounting the
# root device.  Generates output similar to
# systemd-cryptsetup-generator, but with information
# derived from the kernel command line rather
# than /etc/crypttab.
#
normaldir="$1"
earlydir="$2"
latedir="$3"

# Skip generation of units if a root device is
# explicitly provided on the command line.
# Otherwise, extract the boot-slot suffix
# so we know which units to generate.
sfx=
rootrw=
rootflags=
for bootarg in $(cat /proc/cmdline); do
    case "$bootarg" in
	root=*) exit 0 ;;
	boot.slot_suffix=*) sfx="${bootarg##boot.slot_suffix=}";;
	ro) rootrw=no ;;
	rw) rootrw=yes ;;
	rootflags=*) [ -z "$rootflags" ] || rootflags="$rootflags ";
		     rootflags="$rootflags${bootarg##rootflags=}" ;;
    esac
done

if [ -n "$rootrw" ]; then
   if [ "$rootrw" = "yes" ]; then
       rootrw="rw"
   else
       rootrw="ro"
   fi
   if [ -z "$rootflags" ]; then
       rootflags="$rootrw"
   else
       haveflag=
       for flag in $rootflags; do
	   case "$flag" in
	       ro|rw) haveflag=yes;
		      break;;
	   esac
       done
       [ -n "$haveflag" ] || rootflags="$rootflags $rootrw"
   fi
fi

cat >"$normaldir/sysroot.mount" <<EOF
# Automatically generated by bootdev-generator

[Unit]
Description=root mount point from Tegra boot slot
SourcePath=/proc/cmdline
ConditionPathExists=/etc/initrd-release
Before=initrd-root-fs.target
Wants=initrd-root-fs.target
Requires=systemd-cryptsetup@APP$sfx.service
After=blockdev@dev-mapper-APP$sfx.target systemd-cryptsetup@APP$sfx.service initrd-root-device.target

[Mount]
Where=/sysroot
What=/dev/mapper/APP$sfx
Options=$rootflags
EOF

cat >"$normaldir/systemd-cryptsetup@APP$sfx.service" <<EOF
# Automatically generated by bootdev-generator

[Unit]
Description=Cryptography setup for %I
SourcePath=/proc/cmdline
DefaultDependencies=no
IgnoreOnIsolate=true
After=cryptsetup-pre.target dmc-passphrase.service
Before=blockdev@dev-mapper-%i.target
Wants=blockdev@dev-mapper-%i.target
Before=cryptsetup.target initrd-root-device.target
Wants=initrd-root-device.target
RequiresMountsFor=/run
BindsTo=dev-disk-by\x2dpartlabel-crypt\x2dAPP$sfx.device
After=dev-disk-by\x2dpartlabel-crypt\x2dAPP$sfx.device
Before=umount.target

[Service]
Type=oneshot
RemainAfterExit=yes
TimeoutSec=0
KeyringMode=shared
OOMScoreAdjust=500
ExecStart=@NONARCH_BASE_LIBDIR@/systemd/systemd-cryptsetup attach APP$sfx /dev/disk/by-partlabel/crypt-APP$sfx /run/crypt/passphrase luks,x-initrd.attach
ExecStop=@NONARCH_BASE_LIBDIR@/systemd/systemd-cryptsetup detach APP$sfx
EOF

mkdir -p "$normaldir/dev-mapper-APP$sfx.device.d"
cat >"$normaldir/dev-mapper-APP$sfx.device.d/40-device-timeout.conf" <<EOF
# Automatically generated by bootdev-generator

[Unit]
JobTimeoutSec=0
EOF

mkdir -p "$normaldir/dev-mapper-APP$sfx.device.requires"
ln -sf "../systemd-cryptsetup@APP$sfx.service" "$normaldir/dev-mapper-APP$sfx.device.requires/"
mkdir -p "$normaldir/cryptsetup.target.requires"
ln -sf "../systemd-cryptsetup@APP$sfx.service" "$normaldir/cryptsetup.target.requires"
mkdir -p "$normaldir/initrd-root-device.target.requires"
ln -sf "../systemd-cryptsetup@APP$sfx.service" "$normaldir/initrd-root-device.target.requires"
mkdir -p "$normaldir/initrd-root-fs.target.requires"
ln -sf "../sysroot.mount" "$normaldir/initrd-root-fs.target.requires"
exit 0
