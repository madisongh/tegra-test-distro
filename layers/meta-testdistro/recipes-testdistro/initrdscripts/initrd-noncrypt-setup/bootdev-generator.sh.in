#!/bin/sh
#
# Unit generator for mounting the root device,
# based on partition label.
#
normaldir="$1"
earlydir="$2"
latedir="$3"

# Skip generation of units if a root device is
# explicitly provided on the command line.
# Otherwise, extract the boot-slot suffix
# so we know which units to generate.
sfx=
rootrw=
rootflags=
for bootarg in $(cat /proc/cmdline); do
    case "$bootarg" in
	root=*) exit 0 ;;
	boot.slot_suffix=*) sfx="${bootarg##boot.slot_suffix=}";;
	ro) rootrw=no ;;
	rw) rootrw=yes ;;
	rootflags=*) [ -z "$rootflags" ] || rootflags="$rootflags ";
		     rootflags="$rootflags${bootarg##rootflags=}" ;;
    esac
done

if [ -n "$rootrw" ]; then
   if [ "$rootrw" = "yes" ]; then
       rootrw="rw"
   else
       rootrw="ro"
   fi
   if [ -z "$rootflags" ]; then
       rootflags="$rootrw"
   else
       haveflag=
       for flag in $rootflags; do
	   case "$flag" in
	       ro|rw) haveflag=yes;
		      break;;
	   esac
       done
       [ -n "$haveflag" ] || rootflags="$rootflags $rootrw"
   fi
fi

rootdev=$(blkid -t PARTLABEL="APP$sfx" -o device)
[ -n "$rootdev" ] || rootdev=$(blkid -t PARTLABEL="APP$sfx" -o device -p /dev/mmcblk0)

if [ -z "$rootdev" ]; then
    echo "ERROR: no device found with PARTLABEL=APP$sfx" >&2
    exit 1
fi

cat >"$normaldir/sysroot.mount" <<EOF
# Automatically generated by bootdev-generator

[Unit]
Description=root mount point from Tegra boot slot
SourcePath=/proc/cmdline
ConditionPathExists=/etc/initrd-release
Before=initrd-root-fs.target
Requires=dev-mmcblk0.device
Wants=initrd-root-fs.target
After=initrd-root-device.target dev-mmcblk0.device

[Mount]
Where=/sysroot
What=$rootdev
Options=$rootflags
EOF

mkdir -p "$normaldir/initrd-root-fs.target.requires"
ln -sf "../sysroot.mount" "$normaldir/initrd-root-fs.target.requires"
exit 0
